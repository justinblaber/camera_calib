function test_dp_p_d_darg
    p_ps = 1.0e+02 * [0.448548140885415   4.595426819394445];

    % Get analytic derivative
    a = 1.0e+02 * [5.811989327265433;
                   3.115861087870574;
                   2.342314804973926];
    d = [ 0.072064394856535;
         -0.202044348085313;
         -0.025155451778392;
          0.009925044485141];
    dp_p_d_dd = alg.dp_p_d_darg(p_ps, ...
                                @(x_p, y_p, a, x_o, y_o, k1, k2, p, t)[-((x_o-x_p).*(1.0./a.^2.*(x_o-x_p).^2+1.0./a.^2.*(y_o-y_p).^2))./((p.*(x_o-x_p).*(k1.*(1.0./a.^2.*(x_o-x_p).^2+1.0./a.^2.*(y_o-y_p).^2)+k2.*(1.0./a.^2.*(x_o-x_p).^2+1.0./a.^2.*(y_o-y_p).^2).^2+1.0))./a-(t.*(y_o-y_p).*(k1.*(1.0./a.^2.*(x_o-x_p).^2+1.0./a.^2.*(y_o-y_p).^2)+k2.*(1.0./a.^2.*(x_o-x_p).^2+1.0./a.^2.*(y_o-y_p).^2).^2+1.0))./a+1.0)-((t.*(y_o-y_p).*(1.0./a.^2.*(x_o-x_p).^2+1.0./a.^2.*(y_o-y_p).^2))./a-(p.*(x_o-x_p).*(1.0./a.^2.*(x_o-x_p).^2+1.0./a.^2.*(y_o-y_p).^2))./a).*(x_o-x_p).*1.0./((p.*(x_o-x_p).*(k1.*(1.0./a.^2.*(x_o-x_p).^2+1.0./a.^2.*(y_o-y_p).^2)+k2.*(1.0./a.^2.*(x_o-x_p).^2+1.0./a.^2.*(y_o-y_p).^2).^2+1.0))./a-(t.*(y_o-y_p).*(k1.*(1.0./a.^2.*(x_o-x_p).^2+1.0./a.^2.*(y_o-y_p).^2)+k2.*(1.0./a.^2.*(x_o-x_p).^2+1.0./a.^2.*(y_o-y_p).^2).^2+1.0))./a+1.0).^2.*(k1.*(1.0./a.^2.*(x_o-x_p).^2+1.0./a.^2.*(y_o-y_p).^2)+k2.*(1.0./a.^2.*(x_o-x_p).^2+1.0./a.^2.*(y_o-y_p).^2).^2+1.0), -((y_o-y_p).*(1.0./a.^2.*(x_o-x_p).^2+1.0./a.^2.*(y_o-y_p).^2))./((p.*(x_o-x_p).*(k1.*(1.0./a.^2.*(x_o-x_p).^2+1.0./a.^2.*(y_o-y_p).^2)+k2.*(1.0./a.^2.*(x_o-x_p).^2+1.0./a.^2.*(y_o-y_p).^2).^2+1.0))./a-(t.*(y_o-y_p).*(k1.*(1.0./a.^2.*(x_o-x_p).^2+1.0./a.^2.*(y_o-y_p).^2)+k2.*(1.0./a.^2.*(x_o-x_p).^2+1.0./a.^2.*(y_o-y_p).^2).^2+1.0))./a+1.0)-((t.*(y_o-y_p).*(1.0./a.^2.*(x_o-x_p).^2+1.0./a.^2.*(y_o-y_p).^2))./a-(p.*(x_o-x_p).*(1.0./a.^2.*(x_o-x_p).^2+1.0./a.^2.*(y_o-y_p).^2))./a).*(y_o-y_p).*1.0./((p.*(x_o-x_p).*(k1.*(1.0./a.^2.*(x_o-x_p).^2+1.0./a.^2.*(y_o-y_p).^2)+k2.*(1.0./a.^2.*(x_o-x_p).^2+1.0./a.^2.*(y_o-y_p).^2).^2+1.0))./a-(t.*(y_o-y_p).*(k1.*(1.0./a.^2.*(x_o-x_p).^2+1.0./a.^2.*(y_o-y_p).^2)+k2.*(1.0./a.^2.*(x_o-x_p).^2+1.0./a.^2.*(y_o-y_p).^2).^2+1.0))./a+1.0).^2.*(k1.*(1.0./a.^2.*(x_o-x_p).^2+1.0./a.^2.*(y_o-y_p).^2)+k2.*(1.0./a.^2.*(x_o-x_p).^2+1.0./a.^2.*(y_o-y_p).^2).^2+1.0)], ...
                                a, ...
                                d);

    % Get finite difference approximation
    f_p_p2p_p_d = @(x_p, y_p, a, x_o, y_o, k1, k2, p, t)[x_o-((x_o-x_p).*(k1.*(1.0./a.^2.*(x_o-x_p).^2+1.0./a.^2.*(y_o-y_p).^2)+k2.*(1.0./a.^2.*(x_o-x_p).^2+1.0./a.^2.*(y_o-y_p).^2).^2+1.0))./((p.*(x_o-x_p).*(k1.*(1.0./a.^2.*(x_o-x_p).^2+1.0./a.^2.*(y_o-y_p).^2)+k2.*(1.0./a.^2.*(x_o-x_p).^2+1.0./a.^2.*(y_o-y_p).^2).^2+1.0))./a-(t.*(y_o-y_p).*(k1.*(1.0./a.^2.*(x_o-x_p).^2+1.0./a.^2.*(y_o-y_p).^2)+k2.*(1.0./a.^2.*(x_o-x_p).^2+1.0./a.^2.*(y_o-y_p).^2).^2+1.0))./a+1.0), y_o-((y_o-y_p).*(k1.*(1.0./a.^2.*(x_o-x_p).^2+1.0./a.^2.*(y_o-y_p).^2)+k2.*(1.0./a.^2.*(x_o-x_p).^2+1.0./a.^2.*(y_o-y_p).^2).^2+1.0))./((p.*(x_o-x_p).*(k1.*(1.0./a.^2.*(x_o-x_p).^2+1.0./a.^2.*(y_o-y_p).^2)+k2.*(1.0./a.^2.*(x_o-x_p).^2+1.0./a.^2.*(y_o-y_p).^2).^2+1.0))./a-(t.*(y_o-y_p).*(k1.*(1.0./a.^2.*(x_o-x_p).^2+1.0./a.^2.*(y_o-y_p).^2)+k2.*(1.0./a.^2.*(x_o-x_p).^2+1.0./a.^2.*(y_o-y_p).^2).^2+1.0))./a+1.0)];
    p_p_ds = alg.p_p2p_p_d(p_ps, f_p_p2p_p_d, a, d);

    delta = 1e-5;
    d_delta = d;
    d_delta(1) = d_delta(1) + delta;
    p_p_ds_delta = alg.p_p2p_p_d(p_ps, f_p_p2p_p_d, a, d_delta);
    dp_p_d_dd_finite = (p_p_ds_delta - p_p_ds)./delta;

    % Assert
    assert(all(all(abs(dp_p_d_dd - [-97.763248160454921;
                                     82.581816748599650]) < 1e-4)));

    assert(all(all(abs(dp_p_d_dd' - dp_p_d_dd_finite) < 1e-4)));
end
