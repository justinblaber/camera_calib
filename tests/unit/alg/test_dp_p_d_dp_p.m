function test_dp_p_d_dp_p
    p_ps = [195   331;
            505   343;
            231    86;
            485    88];
        
    % Undistort
    a = 1.0e+02 * [5.811989327265433;
                   3.115861087870574;
                   2.342314804973926];
    d = [ 0.072064394856535;
         -0.202044348085313;
         -0.025155451778392;
          0.009925044485141];
    dp_p_d_dp_p = alg.dp_p_d_dp_p(p_ps, ...
                                  @(x_p,y_p,a,x_o,y_o,k1,k2,p,t)[(k1.*(1.0./a.^2.*(x_o-x_p).^2+1.0./a.^2.*(y_o-y_p).^2)+k2.*(1.0./a.^2.*(x_o-x_p).^2+1.0./a.^2.*(y_o-y_p).^2).^2+1.0)./((p.*(x_o-x_p).*(k1.*(1.0./a.^2.*(x_o-x_p).^2+1.0./a.^2.*(y_o-y_p).^2)+k2.*(1.0./a.^2.*(x_o-x_p).^2+1.0./a.^2.*(y_o-y_p).^2).^2+1.0))./a-(t.*(y_o-y_p).*(k1.*(1.0./a.^2.*(x_o-x_p).^2+1.0./a.^2.*(y_o-y_p).^2)+k2.*(1.0./a.^2.*(x_o-x_p).^2+1.0./a.^2.*(y_o-y_p).^2).^2+1.0))./a+1.0)+((1.0./a.^2.*k1.*(x_o.*2.0-x_p.*2.0)+1.0./a.^2.*k2.*(x_o.*2.0-x_p.*2.0).*(1.0./a.^2.*(x_o-x_p).^2+1.0./a.^2.*(y_o-y_p).^2).*2.0).*(x_o-x_p))./((p.*(x_o-x_p).*(k1.*(1.0./a.^2.*(x_o-x_p).^2+1.0./a.^2.*(y_o-y_p).^2)+k2.*(1.0./a.^2.*(x_o-x_p).^2+1.0./a.^2.*(y_o-y_p).^2).^2+1.0))./a-(t.*(y_o-y_p).*(k1.*(1.0./a.^2.*(x_o-x_p).^2+1.0./a.^2.*(y_o-y_p).^2)+k2.*(1.0./a.^2.*(x_o-x_p).^2+1.0./a.^2.*(y_o-y_p).^2).^2+1.0))./a+1.0)-(x_o-x_p).*1.0./((p.*(x_o-x_p).*(k1.*(1.0./a.^2.*(x_o-x_p).^2+1.0./a.^2.*(y_o-y_p).^2)+k2.*(1.0./a.^2.*(x_o-x_p).^2+1.0./a.^2.*(y_o-y_p).^2).^2+1.0))./a-(t.*(y_o-y_p).*(k1.*(1.0./a.^2.*(x_o-x_p).^2+1.0./a.^2.*(y_o-y_p).^2)+k2.*(1.0./a.^2.*(x_o-x_p).^2+1.0./a.^2.*(y_o-y_p).^2).^2+1.0))./a+1.0).^2.*(k1.*(1.0./a.^2.*(x_o-x_p).^2+1.0./a.^2.*(y_o-y_p).^2)+k2.*(1.0./a.^2.*(x_o-x_p).^2+1.0./a.^2.*(y_o-y_p).^2).^2+1.0).*((p.*(k1.*(1.0./a.^2.*(x_o-x_p).^2+1.0./a.^2.*(y_o-y_p).^2)+k2.*(1.0./a.^2.*(x_o-x_p).^2+1.0./a.^2.*(y_o-y_p).^2).^2+1.0))./a+(p.*(1.0./a.^2.*k1.*(x_o.*2.0-x_p.*2.0)+1.0./a.^2.*k2.*(x_o.*2.0-x_p.*2.0).*(1.0./a.^2.*(x_o-x_p).^2+1.0./a.^2.*(y_o-y_p).^2).*2.0).*(x_o-x_p))./a-(t.*(1.0./a.^2.*k1.*(x_o.*2.0-x_p.*2.0)+1.0./a.^2.*k2.*(x_o.*2.0-x_p.*2.0).*(1.0./a.^2.*(x_o-x_p).^2+1.0./a.^2.*(y_o-y_p).^2).*2.0).*(y_o-y_p))./a),((1.0./a.^2.*k1.*(x_o.*2.0-x_p.*2.0)+1.0./a.^2.*k2.*(x_o.*2.0-x_p.*2.0).*(1.0./a.^2.*(x_o-x_p).^2+1.0./a.^2.*(y_o-y_p).^2).*2.0).*(y_o-y_p))./((p.*(x_o-x_p).*(k1.*(1.0./a.^2.*(x_o-x_p).^2+1.0./a.^2.*(y_o-y_p).^2)+k2.*(1.0./a.^2.*(x_o-x_p).^2+1.0./a.^2.*(y_o-y_p).^2).^2+1.0))./a-(t.*(y_o-y_p).*(k1.*(1.0./a.^2.*(x_o-x_p).^2+1.0./a.^2.*(y_o-y_p).^2)+k2.*(1.0./a.^2.*(x_o-x_p).^2+1.0./a.^2.*(y_o-y_p).^2).^2+1.0))./a+1.0)-(y_o-y_p).*1.0./((p.*(x_o-x_p).*(k1.*(1.0./a.^2.*(x_o-x_p).^2+1.0./a.^2.*(y_o-y_p).^2)+k2.*(1.0./a.^2.*(x_o-x_p).^2+1.0./a.^2.*(y_o-y_p).^2).^2+1.0))./a-(t.*(y_o-y_p).*(k1.*(1.0./a.^2.*(x_o-x_p).^2+1.0./a.^2.*(y_o-y_p).^2)+k2.*(1.0./a.^2.*(x_o-x_p).^2+1.0./a.^2.*(y_o-y_p).^2).^2+1.0))./a+1.0).^2.*(k1.*(1.0./a.^2.*(x_o-x_p).^2+1.0./a.^2.*(y_o-y_p).^2)+k2.*(1.0./a.^2.*(x_o-x_p).^2+1.0./a.^2.*(y_o-y_p).^2).^2+1.0).*((p.*(k1.*(1.0./a.^2.*(x_o-x_p).^2+1.0./a.^2.*(y_o-y_p).^2)+k2.*(1.0./a.^2.*(x_o-x_p).^2+1.0./a.^2.*(y_o-y_p).^2).^2+1.0))./a+(p.*(1.0./a.^2.*k1.*(x_o.*2.0-x_p.*2.0)+1.0./a.^2.*k2.*(x_o.*2.0-x_p.*2.0).*(1.0./a.^2.*(x_o-x_p).^2+1.0./a.^2.*(y_o-y_p).^2).*2.0).*(x_o-x_p))./a-(t.*(1.0./a.^2.*k1.*(x_o.*2.0-x_p.*2.0)+1.0./a.^2.*k2.*(x_o.*2.0-x_p.*2.0).*(1.0./a.^2.*(x_o-x_p).^2+1.0./a.^2.*(y_o-y_p).^2).*2.0).*(y_o-y_p))./a)], ...
                                  @(x_p,y_p,a,x_o,y_o,k1,k2,p,t)[((1.0./a.^2.*k1.*(y_o.*2.0-y_p.*2.0)+1.0./a.^2.*k2.*(y_o.*2.0-y_p.*2.0).*(1.0./a.^2.*(x_o-x_p).^2+1.0./a.^2.*(y_o-y_p).^2).*2.0).*(x_o-x_p))./((p.*(x_o-x_p).*(k1.*(1.0./a.^2.*(x_o-x_p).^2+1.0./a.^2.*(y_o-y_p).^2)+k2.*(1.0./a.^2.*(x_o-x_p).^2+1.0./a.^2.*(y_o-y_p).^2).^2+1.0))./a-(t.*(y_o-y_p).*(k1.*(1.0./a.^2.*(x_o-x_p).^2+1.0./a.^2.*(y_o-y_p).^2)+k2.*(1.0./a.^2.*(x_o-x_p).^2+1.0./a.^2.*(y_o-y_p).^2).^2+1.0))./a+1.0)+(x_o-x_p).*1.0./((p.*(x_o-x_p).*(k1.*(1.0./a.^2.*(x_o-x_p).^2+1.0./a.^2.*(y_o-y_p).^2)+k2.*(1.0./a.^2.*(x_o-x_p).^2+1.0./a.^2.*(y_o-y_p).^2).^2+1.0))./a-(t.*(y_o-y_p).*(k1.*(1.0./a.^2.*(x_o-x_p).^2+1.0./a.^2.*(y_o-y_p).^2)+k2.*(1.0./a.^2.*(x_o-x_p).^2+1.0./a.^2.*(y_o-y_p).^2).^2+1.0))./a+1.0).^2.*(k1.*(1.0./a.^2.*(x_o-x_p).^2+1.0./a.^2.*(y_o-y_p).^2)+k2.*(1.0./a.^2.*(x_o-x_p).^2+1.0./a.^2.*(y_o-y_p).^2).^2+1.0).*((t.*(k1.*(1.0./a.^2.*(x_o-x_p).^2+1.0./a.^2.*(y_o-y_p).^2)+k2.*(1.0./a.^2.*(x_o-x_p).^2+1.0./a.^2.*(y_o-y_p).^2).^2+1.0))./a-(p.*(1.0./a.^2.*k1.*(y_o.*2.0-y_p.*2.0)+1.0./a.^2.*k2.*(y_o.*2.0-y_p.*2.0).*(1.0./a.^2.*(x_o-x_p).^2+1.0./a.^2.*(y_o-y_p).^2).*2.0).*(x_o-x_p))./a+(t.*(1.0./a.^2.*k1.*(y_o.*2.0-y_p.*2.0)+1.0./a.^2.*k2.*(y_o.*2.0-y_p.*2.0).*(1.0./a.^2.*(x_o-x_p).^2+1.0./a.^2.*(y_o-y_p).^2).*2.0).*(y_o-y_p))./a),(k1.*(1.0./a.^2.*(x_o-x_p).^2+1.0./a.^2.*(y_o-y_p).^2)+k2.*(1.0./a.^2.*(x_o-x_p).^2+1.0./a.^2.*(y_o-y_p).^2).^2+1.0)./((p.*(x_o-x_p).*(k1.*(1.0./a.^2.*(x_o-x_p).^2+1.0./a.^2.*(y_o-y_p).^2)+k2.*(1.0./a.^2.*(x_o-x_p).^2+1.0./a.^2.*(y_o-y_p).^2).^2+1.0))./a-(t.*(y_o-y_p).*(k1.*(1.0./a.^2.*(x_o-x_p).^2+1.0./a.^2.*(y_o-y_p).^2)+k2.*(1.0./a.^2.*(x_o-x_p).^2+1.0./a.^2.*(y_o-y_p).^2).^2+1.0))./a+1.0)+((1.0./a.^2.*k1.*(y_o.*2.0-y_p.*2.0)+1.0./a.^2.*k2.*(y_o.*2.0-y_p.*2.0).*(1.0./a.^2.*(x_o-x_p).^2+1.0./a.^2.*(y_o-y_p).^2).*2.0).*(y_o-y_p))./((p.*(x_o-x_p).*(k1.*(1.0./a.^2.*(x_o-x_p).^2+1.0./a.^2.*(y_o-y_p).^2)+k2.*(1.0./a.^2.*(x_o-x_p).^2+1.0./a.^2.*(y_o-y_p).^2).^2+1.0))./a-(t.*(y_o-y_p).*(k1.*(1.0./a.^2.*(x_o-x_p).^2+1.0./a.^2.*(y_o-y_p).^2)+k2.*(1.0./a.^2.*(x_o-x_p).^2+1.0./a.^2.*(y_o-y_p).^2).^2+1.0))./a+1.0)+(y_o-y_p).*1.0./((p.*(x_o-x_p).*(k1.*(1.0./a.^2.*(x_o-x_p).^2+1.0./a.^2.*(y_o-y_p).^2)+k2.*(1.0./a.^2.*(x_o-x_p).^2+1.0./a.^2.*(y_o-y_p).^2).^2+1.0))./a-(t.*(y_o-y_p).*(k1.*(1.0./a.^2.*(x_o-x_p).^2+1.0./a.^2.*(y_o-y_p).^2)+k2.*(1.0./a.^2.*(x_o-x_p).^2+1.0./a.^2.*(y_o-y_p).^2).^2+1.0))./a+1.0).^2.*(k1.*(1.0./a.^2.*(x_o-x_p).^2+1.0./a.^2.*(y_o-y_p).^2)+k2.*(1.0./a.^2.*(x_o-x_p).^2+1.0./a.^2.*(y_o-y_p).^2).^2+1.0).*((t.*(k1.*(1.0./a.^2.*(x_o-x_p).^2+1.0./a.^2.*(y_o-y_p).^2)+k2.*(1.0./a.^2.*(x_o-x_p).^2+1.0./a.^2.*(y_o-y_p).^2).^2+1.0))./a-(p.*(1.0./a.^2.*k1.*(y_o.*2.0-y_p.*2.0)+1.0./a.^2.*k2.*(y_o.*2.0-y_p.*2.0).*(1.0./a.^2.*(x_o-x_p).^2+1.0./a.^2.*(y_o-y_p).^2).*2.0).*(x_o-x_p))./a+(t.*(1.0./a.^2.*k1.*(y_o.*2.0-y_p.*2.0)+1.0./a.^2.*k2.*(y_o.*2.0-y_p.*2.0).*(1.0./a.^2.*(x_o-x_p).^2+1.0./a.^2.*(y_o-y_p).^2).*2.0).*(y_o-y_p))./a)], ...
                                  a, ...
                                  d);
                           
    % Get finite difference approximation
    f_p_p2p_p_d = @(x_p,y_p,a,x_o,y_o,k1,k2,p,t)[x_o-((x_o-x_p).*(k1.*(1.0./a.^2.*(x_o-x_p).^2+1.0./a.^2.*(y_o-y_p).^2)+k2.*(1.0./a.^2.*(x_o-x_p).^2+1.0./a.^2.*(y_o-y_p).^2).^2+1.0))./((p.*(x_o-x_p).*(k1.*(1.0./a.^2.*(x_o-x_p).^2+1.0./a.^2.*(y_o-y_p).^2)+k2.*(1.0./a.^2.*(x_o-x_p).^2+1.0./a.^2.*(y_o-y_p).^2).^2+1.0))./a-(t.*(y_o-y_p).*(k1.*(1.0./a.^2.*(x_o-x_p).^2+1.0./a.^2.*(y_o-y_p).^2)+k2.*(1.0./a.^2.*(x_o-x_p).^2+1.0./a.^2.*(y_o-y_p).^2).^2+1.0))./a+1.0),y_o-((y_o-y_p).*(k1.*(1.0./a.^2.*(x_o-x_p).^2+1.0./a.^2.*(y_o-y_p).^2)+k2.*(1.0./a.^2.*(x_o-x_p).^2+1.0./a.^2.*(y_o-y_p).^2).^2+1.0))./((p.*(x_o-x_p).*(k1.*(1.0./a.^2.*(x_o-x_p).^2+1.0./a.^2.*(y_o-y_p).^2)+k2.*(1.0./a.^2.*(x_o-x_p).^2+1.0./a.^2.*(y_o-y_p).^2).^2+1.0))./a-(t.*(y_o-y_p).*(k1.*(1.0./a.^2.*(x_o-x_p).^2+1.0./a.^2.*(y_o-y_p).^2)+k2.*(1.0./a.^2.*(x_o-x_p).^2+1.0./a.^2.*(y_o-y_p).^2).^2+1.0))./a+1.0)];
    p_p_ds = alg.p_p2p_p_d(p_ps,f_p_p2p_p_d,a,d);  
        
    delta = 1e-2;
    dp_p_d_dp_p_finite = sparse(8,8);
    for i = 1:size(p_ps,1)        
        p_p_delta = p_ps(i,:);
        p_p_delta(1) = p_p_delta(1) + delta;
        
        p_p_d_delta = alg.p_p2p_p_d(p_p_delta,f_p_p2p_p_d,a,d);
        dp_p_d_dp_p_finite(2*i-1:2*i,2*i-1) = (p_p_d_delta-p_p_ds(i,:))./delta; %#ok<SPRIX>
        
        p_p_delta = p_ps(i,:);
        p_p_delta(2) = p_p_delta(2) + delta;
        
        p_p_d_delta = alg.p_p2p_p_d(p_p_delta,f_p_p2p_p_d,a,d);
        dp_p_d_dp_p_finite(2*i-1:2*i,2*i) = (p_p_d_delta-p_p_ds(i,:))./delta; %#ok<SPRIX>
    end
    
                              
    % Assert
    assert(all(all(full(abs(dp_p_d_dp_p - sparse([ 1.016131662425826  -0.000979257566982                   0                   0                   0                   0                   0                   0;
                                                  -0.007250264472910   1.008209389998896                   0                   0                   0                   0                   0                   0;
                                                                   0                   0   0.990512943831006  -0.001670205492409                   0                   0                   0                   0;
                                                                   0                   0  -0.003063699699523   0.995021603587784                   0                   0                   0                   0;
                                                                   0                   0                   0                   0   1.015793038371775   0.004127072559991                   0                   0;
                                                                   0                   0                   0                   0   0.009275608162813   1.018341758518644                   0                   0;
                                                                   0                   0                   0                   0                   0                   0   0.995571092537874  -0.004530855389848;
                                                                   0                   0                   0                   0                   0                   0   0.004782807587692   1.005063607408561]))) < 1e-4)));
                                                               
    assert(all(all(abs(dp_p_d_dp_p - dp_p_d_dp_p_finite) < 1e-4)));
end